parameters:
- name: 'enableNfs'
  type: string
  default: 'n'
steps:
- template: ../templates/prepare-mirror-agent.yaml
- template: ../templates/prepare-mirror-storage.yaml
  parameters:
    storageAccount: $(StorageAccount)
    storageAccountSasToken: $(StorageAccountSasToken)
    storageAccountReplica: $(StorageAccountReplica)
    storageAccountReplicaSasToken: $(StorageAccountReplicaSasToken)
    publishToReplica: $(PublishToReplica)
    mirrorName: $(Mirror_Name)
    enableNfs: {{ parameters.enableNfs }}
- bash: |
    echo "$(sonic-gpg-enc-private-key)" > "encrypted_private_key.gpg"
    scripts/mirror/aptly.sh "$(CreateDB)" "$(Mirror_Name)" "$(Mirror_URL)" "$(Mirror_Distributions)" "$(Mirror_Architectures)" "$(Mirror_Components)" "$(MIRROR_FILESYSTEM)"
  env:
    PASSPHRASE: $(sonic-gpg-passphrase)
    
  displayName: 'Update and publish debian mirrors by aptly'
