# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger: none

pool: sonic-mirror-build-2

parameters:
- name: 'platforms'
  type: object
  default:
  - vs:
    prestep:
    targets: 'target/sonic-vs.bin'
    options:
    poststeps:
    - bash:
  - broadcom:
- name: 'publishjob'
  type: job
  default:
    job:
    steps:
    - bash: |
        echo "test"
stages:
- stage: Build
  jobs:
  - ${{ each mirrorName in parameters.mirrorNames }}:
    - ${{ each pair in parameters.publishjob }}:
        ${{ if and(ne(pair.key, 'steps'), ne(pair.key, 'job')) }}:
          ${{ pair.key }}: ${{ pair.value }}
      job: ${{ format('Publish_mirror_{0}', replace(mirrorName, '-', '_')) }}
      timeoutInMinutes: 0
      steps:
      - bash: |
          echo "pre-step"
          MirrorNames=${{ join(',', parameters.mirrorNames) }}
          echo "MirrorNames=$MirrorNames"
          echo "$MirrorNames" > work/_aptly/mirror_names
        displayName: 'pre-step'
